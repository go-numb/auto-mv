## 自動動画作成ツール 技術ドキュメント

### 1. プロジェクト概要

本プロジェクトは、脚本に基づいて自動的に動画を作成するツールです。テキストベースの脚本から音声を生成し、字幕と画像を動画に重ね合わせて、完成度の高い動画を効率的に作成することを目的としています。

### 2. まず利用するために

**ステップ 1: 環境設定**

1. **Rust のインストール:** [https://www.rust-lang.org/](https://www.rust-lang.org/) から Rust をインストールします。
2. **依存関係のインストール:** プロジェクトルートディレクトリで `cargo build` を実行します。
3. **音声合成ライブラリの準備:**  音声合成ライブラリとして、`speech.exe` を使用します。このライブラリは、[https://www.microsoft.com/en-us/microsoft-365/speech](https://www.microsoft.com/en-us/microsoft-365/speech) からダウンロードできます。
4. **環境変数の設定:** `dotenv` ライブラリを使用して、`.env` ファイルに以下の環境変数を設定します。
   - `OVERWRITE`: 動画出力時に上書きを許可する場合は `true`、そうでなければ `false` を設定します。
   - `NVIDIA`: NVIDIA GPU を使用して動画エンコードを行う場合は `true`、そうでなければ `false` を設定します。
   - `WAITING_SEC_AFTER_SPEAKING`: 音声再生後の待機時間（秒単位）を設定します。

**ステップ 2: スクリプトの作成**

1. `source` ディレクトリに `scripts.txt` ファイルを作成します。
2. ファイル内に、動画の脚本をテキスト形式で記述します。各行は、音声合成の対象となるテキストを表します。

**ステップ 3: 動画の作成**

1. プロジェクトルートディレクトリで `cargo run` を実行します。
2. 動画は `source` ディレクトリ内の `result.mp4` ファイルに生成されます。

**ステップ 4: 字幕ファイルの確認**

1. 動画と共に、`source` ディレクトリ内に `subtitle.ass` ファイルが生成されます。
2. このファイルには、動画の字幕情報が ASS 形式で記述されています。

### 3. ファイル構造図とディレクトリ説明

```
├── Cargo.toml
├── source
│   ├── scripts.txt
│   └── 0-brank.mp4
└── src
    ├── ffmpeg
    │   └── command.rs
    ├── main.rs
    ├── speech
    │   ├── local.rs
    │   └── voice.rs
    └── models
        └── ass_subtitle.rs

```

- **source:** 脚本ファイル、画像、出力動画、字幕ファイルなどのソースデータや出力ファイルを格納するディレクトリ。
  - **scripts.txt:** 動画の脚本をテキスト形式で記述したファイル。
  - **result.mp4:** 自動生成された最終的な動画ファイル。
  - **subtitle.ass:** 動画の字幕情報を ASS 形式で記述したファイル。
- **src:** ソースコードを格納するディレクトリ。
  - **ffmpeg:** ffmpeg ライブラリを使用するためのモジュール。
    - **command.rs:** ffmpeg コマンドを実行するための関数を実装したファイル。
  - **main.rs:** 動画作成処理を実行するメインプログラム。
  - **speech:** 音声合成処理を行うモジュール。
    - **local.rs:** 音声合成ライブラリ `speech.exe` を使用して、テキストから音声を生成する関数を実装したファイル。
    - **voice.rs:** 音声合成ライブラリで使用される音声の種類や言語を定義したファイル。
  - **models:** 動画作成に必要なデータ構造体や関数を定義したモジュール。
    - **ass_subtitle.rs:** ASS 形式の字幕情報を扱う構造体や関数を定義したファイル。

### 4. 各ファイル・モジュールの詳細

#### 4.1. `main.rs`

- **目的:** 動画作成処理のメインプログラム。脚本に基づいて、音声合成、字幕の生成、画像のオーバーレイなどの処理を順番に実行します。
- **主要な関数:** `main()` 関数は、動画作成処理全体の制御を行い、以下のような処理を実行します。
  - 脚本ファイルを読み込み、テキストを音声に変換します。
  - 音声の長さを取得し、字幕情報を生成します。
  - 画像のオーバーレイに関する情報を生成します。
  - ffmpeg コマンドを使用して、字幕と画像を動画にオーバーレイします。
- **依存関係:**
  - `dotenv`: 環境変数を設定するためのライブラリ。
  - `log`: ログ出力用のライブラリ。
  - `ffmpeg`: ffmpeg コマンドを実行するためのモジュール。
  - `speech`: 音声合成処理を行うモジュール。
  - `models`: 動画作成に必要なデータ構造体や関数を定義したモジュール。

#### 4.2. `ffmpeg/command.rs`

- **目的:** ffmpeg コマンドを実行するための関数を実装したファイル。
- **主要な関数:**
  - `brank()`: 指定された解像度と時間の長さの空白動画を生成します。
  - `add_image_overlay()`: 動画に画像をオーバーレイします。
  - `add_subs()`: 動画に字幕を追加します。
  - `add_audio()`: 動画に音声を追加します。
  - `cut()`: 指定された時間の長さで動画を分割します。
  - `crop()`: 動画を指定された開始時間と終了時間の間で切り抜きます。
- **依存関係:**
  - `std::env`: 環境変数を取得するためのライブラリ。
  - `std::fs`: ファイル操作を行うためのライブラリ。
  - `std::process::Command`: コマンドを実行するためのライブラリ。
  - `std::time::Duration`: 時間を扱うためのライブラリ。

#### 4.3. `speech/local.rs`

- **目的:** 音声合成ライブラリ `speech.exe` を使用して、テキストから音声を生成する関数を実装したファイル。
- **主要な関数:** `command()`: テキストと音声合成オプションを指定して、音声を生成します。
- **依存関係:**
  - `std::fs::File`: ファイル操作を行うためのライブラリ。
  - `std::process::Command`: コマンドを実行するためのライブラリ。
  - `std::io`: 入力出力処理を行うためのライブラリ。
  - `std::time::Duration`: 時間を扱うためのライブラリ。

#### 4.4. `speech/voice.rs`

- **目的:** 音声合成ライブラリで使用される音声の種類や言語を定義したファイル。
- **主要な関数:** `from()`: 音声の種類と番号を指定して、音声の種類を返します。
- **依存関係:** `std::fmt`: デバッグ出力のためのライブラリ。

#### 4.5. `models/ass_subtitle.rs`

- **目的:** ASS 形式の字幕情報を扱う構造体や関数を定義したファイル。
- **主要な構造体:**
  - `Subtitle`: 字幕情報を表す構造体。
  - `Style`: 字幕のスタイル情報を表す構造体。
- **主要な関数:**
  - `format_duration_as_time()`: `Duration` 型の時間を ASS 形式の時間に変換します。
  - `escape_ass_text()`: ASS 形式のテキストをエスケープします。
  - `create_ass_file()`: 字幕情報から ASS 形式の字幕ファイルを作成します。

### 5. 設計アルゴリズムやパターン

本プロジェクトでは、以下の設計パターンやアルゴリズムが使用されています。

- **コマンドパターン:** ffmpeg コマンドを実行するための `command.rs` モジュールでは、コマンドパターンが使用されています。各 ffmpeg コマンドは、`Command` 構造体で表現され、`args()` メソッドを使用してコマンドのパラメータを指定することができます。これにより、ffmpeg コマンドの実行をカプセル化し、コードの可読性を向上させています。

- **イベント駆動:**  `main.rs` はイベント駆動型設計を採用しています。脚本ファイルの各行がイベントとして処理され、各イベントに対して音声合成、字幕生成、画像オーバーレイなどの処理が実行されます。

- **データ構造:**  字幕情報や画像情報を適切に管理するために、`ass_subtitle.rs` には `Subtitle` 構造体と `Style` 構造体が定義されています。これらの構造体は、字幕情報やスタイル情報を効率的に格納し、処理するために使用されます。

### 6. 環境構築・セットアップ手順

1. **Rust のインストール:** [https://www.rust-lang.org/](https://www.rust-lang.org/) から Rust をインストールします。
2. **依存関係のインストール:** プロジェクトルートディレクトリで `cargo build` を実行します。
3. **音声合成ライブラリの準備:** `speech.exe` を [https://www.microsoft.com/en-us/microsoft-365/speech](https://www.microsoft.com/en-us/microsoft-365/speech) からダウンロードして、プロジェクトルートディレクトリに配置します。
4. **環境変数の設定:** プロジェクトルートディレクトリに `.env` ファイルを作成し、以下のように環境変数を設定します。
   ```
   OVERWRITE=true
   NVIDIA=false
   WAITING_SEC_AFTER_SPEAKING=1
   ```
5. **ffmpeg のインストール:** ffmpeg は、[https://ffmpeg.org/](https://ffmpeg.org/) からダウンロードしてインストールします。

### 7. ベストプラクティスと拡張方法

- **コードの可読性:**  コードの可読性を高めるために、関数や変数に適切な名前を付け、コメントを記述する必要があります。特に、ffmpeg コマンドの実行部分など、複雑な処理には、コメントを記述して処理内容を明確にする必要があります。
- **エラー処理:**  コードの安定性を高めるために、エラー処理は必須です。`Result` 型や `Option` 型を使用し、エラーが発生した場合に適切な処理を行う必要があります。特に、ファイル操作や外部ライブラリの呼び出し時には、エラーが発生しやすいので、注意が必要です。
- **テストの追加:** コードの品質を向上させるために、テストを追加する必要があります。ユニットテストや統合テストを作成し、コードの機能が正しく動作することを確認する必要があります。
- **拡張性:**  将来的に機能を追加することを考慮して、コードを設計する必要があります。例えば、インターフェースや抽象クラスを使用することで、コードの変更に強い設計を実現できます。

### 新規参加者や利用者向けの追記

- **依存ライブラリ:** 本プロジェクトでは、`ffmpeg` ライブラリと `speech.exe` が重要な役割を果たします。`ffmpeg` は動画処理、`speech.exe` は音声合成に使用されます。
- **動作上の特殊な要件:** 音声合成には、`speech.exe` が必要です。また、ffmpeg を使用して動画処理を行うため、ffmpeg がインストールされている必要があります。
- **推奨される使用ケース:** 本プロジェクトは、脚本に基づいて動画を自動生成したい場合に適しています。特に、字幕と画像のオーバーレイを自動化することで、動画制作の効率化に役立ちます。
- **ライブラリやモジュールを使用するタイミング:** `ffmpeg` モジュールは、動画処理を行う際に使用します。`speech` モジュールは、テキストを音声に変換する際に使用します。`models` モジュールは、動画作成に必要なデータ構造体や関数を定義しており、他のモジュールから使用されます。

**本ドキュメントは、本プロジェクトへの理解を深め、開発や利用を円滑に進めるための指針となります。疑問点やご意見は、お気軽にご連絡ください。**
